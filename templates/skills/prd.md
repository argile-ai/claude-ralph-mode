# PRD - Convert Plan to JSON

Convert a validated `plan.md` into an executable `prd.json` for Ralph.

---

## The Job

1. Read the plan from `plan.md`
2. Read repository configuration from `ralph.config.json`
3. Parse user stories and convert to JSON format
4. Generate `prd.json` with proper structure
5. Display summary and next steps

---

## Step 1: Validate Prerequisites

Check that these files exist:
- `plan.md` - The implementation plan (generated by `/ralph`)
- `ralph.config.json` - Project configuration

If `plan.md` doesn't exist, instruct the user to run `/ralph <feature>` first.

---

## Step 2: Parse Plan

Extract from `plan.md`:
- Project name (from H1 heading)
- Feature description (from intro paragraph)
- User stories (from ## User Stories section)

For each user story, extract:
- ID (US-001, US-002, etc.)
- Title
- Repository name
- Description
- Acceptance criteria (as array)

---

## Step 3: Generate PRD JSON

Create `prd.json` with this structure:

```json
{
  "project": "[Project Name]",
  "description": "[Feature Description]",
  "repositories": {
    "[repo-key]": {
      "branchName": "feature/[feature-slug]"
    }
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "[Story Title]",
      "repo": "[repo-key]",
      "description": "[Full description]",
      "acceptanceCriteria": [
        "Criterion 1",
        "Criterion 2",
        "Tests pass"
      ],
      "priority": 1,
      "passes": false,
      "fork": false,
      "notes": ""
    }
  ]
}
```

---

## Step 4: Repository Mapping

Map story repositories to config keys:
- Read `repositories` from `ralph.config.json`
- Match story repository names to config keys
- Use the repository path for execution

Example mapping:
- Story says `backend` -> maps to config key `backend` -> path `./backend`
- Story says `frontend` -> maps to config key `frontend` -> path `./frontend`

---

## Step 5: Branch Naming

Generate branch names automatically:
- Convert feature name to kebab-case
- Prefix with `feature/`
- Example: "User Authentication" -> `feature/user-authentication`

---

## Step 6: Priority Assignment

Assign priorities based on:
1. Backend/database stories first (priority 1-N)
2. Frontend stories after (priority N+1-M)
3. Integration stories last (priority M+1-...)

Within each category, maintain the order from the plan.

---

## Step 7: Fork Detection

Set `fork: true` for stories that:
- Represent a significant direction change
- Follow a story that might fail and need rollback
- Are marked as "experimental" in the plan

Default is `fork: false`.

---

## Step 8: Output and Summary

After generating `prd.json`, display:

```
PRD Generated Successfully!

Project: [Name]
Stories: [N] total
  - Backend: [X] stories
  - Frontend: [Y] stories

Repositories:
  - [repo1]: feature/[branch]
  - [repo2]: feature/[branch]

Next steps:
1. Review prd.json if needed
2. Run: ./ralph.sh [max_iterations]
```

---

## Output

**File:** `prd.json`

---

## Example

Input (`plan.md`):
```markdown
# MyApp - User Authentication

Add OAuth-based authentication...

## User Stories

### Backend Stories

#### US-001: Add User Model
**Repository:** `backend`
...
```

Output (`prd.json`):
```json
{
  "project": "MyApp - User Authentication",
  "repositories": {
    "backend": { "branchName": "feature/user-authentication" }
  },
  "userStories": [...]
}
```
