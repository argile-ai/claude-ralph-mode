# Ralph Progress Log
Started: Jeu  8 jan 2026 14:26:17 CET

## Codebase Patterns

### argile-lib-python
- Alembic migrations go in `alembic/versions/` with naming convention `YYYYMMDD_description.py`
- Use `argile.services.migration_helpers` for idempotent migrations (column_exists, index_exists, etc.)
- Document models are in `argile/modules/doc_instances/models/document.py`
- SQLModel for database models, Pydantic for schemas
- Always use `t.Annotated` for type annotations with Field
- Pre-commit hooks run: ruff check, ty check, mypy, Vulture
- Current migration head format: `revision: str = "YYYYMMDD_short_name"`

### remi-web-ui
(Add patterns here)

---

## 2026-01-08 14:45 - US-001 (argile-lib-python)
- **What was implemented:**
  - Created Alembic migration to rename PDF columns to generic document columns
  - Renamed: trame_pdf_url → trame_document_url, generated_pdf_url → generated_document_url, signed_pdf_url → signed_document_url
  - Updated DocumentInstanceBase model with new field names
  - Updated all 21 files across the codebase that referenced these columns

- **Files changed in argile-lib-python:**
  - alembic/versions/20260108_rename_pdf_columns_to_document.py (new)
  - argile/modules/doc_instances/models/document.py
  - argile/modules/doc_instances/helpers.py
  - argile/modules/doc_instances/api.py
  - argile/modules/document_bundles/helpers.py
  - argile/modules/quotes/models.py
  - argile/modules/signatures/helpers.py
  - argile/vendors/temporal/activities/document_signatures.py
  - argile/vendors/yousign/provider.py
  - argile/vendors/yousign/helpers.py
  - argile/vendors/hubspot/external_identity_providers/middleware.py
  - argile/vendors/hubspot/external_identity_providers/homelior.py
  - Plus test files (conftest.py, test_*.py)

- **Commit:** 546c23647

- **Learnings for future iterations:**
  - The Hubspot mapping values like `argl_generated_pdf_url` are external field names in Hubspot, not DB columns - don't change these
  - Local variable names for storing URLs (like `signed_pdf_url = download_signed_document(...)`) are fine to keep as is
  - Pre-commit hooks validate: ruff, ty check, mypy, Vulture - all must pass
  - Use Task agent for bulk find-and-replace across many files
---

## 2026-01-08 15:30 - US-002 (argile-lib-python)
- **What was implemented:**
  - Added DocumentFormat enum with PDF, CSV, XLSX values
  - Added FEC_EXPORT value to DocumentType enum
  - Added document_format field to DocumentInstanceBase with default PDF
  - Created Alembic migration that:
    - Creates document_format enum type
    - Adds document_format column with server_default='pdf'
    - Adds fec_export to document_type enum (IF NOT EXISTS)

- **Files changed in argile-lib-python:**
  - argile/modules/doc_instances/models/document.py
  - alembic/versions/20260108_add_document_format_and_fec_export.py (new)

- **Commit:** 5a492942a

- **Learnings for future iterations:**
  - Use `server_default="pdf"` (lowercase) for PostgreSQL enum defaults since our StrEnum uses lowercase values
  - Enum values are added with `ALTER TYPE ... ADD VALUE IF NOT EXISTS` for idempotency
  - Running full test suite requires complete env config (.env files with secrets) - type checking validates code correctness without full config
---

## 2026-01-08 16:15 - US-003 (argile-lib-python)
- **What was implemented:**
  - Created new finances module structure: argile/modules/finances/
  - Created constants.py with FEC accounting constants:
    - FEC_JOURNAL_CODE = "VE" (sales journal)
    - Client accounts (TTC): 41100000 (5.5%), 41110000 (10%), 41120000 (20%)
    - Work accounts (HT): 70400500 (5.5%), 70400100 (10%), 70400200 (20%)
    - VAT collected accounts: 44570000 (5.5%), 44571000 (10%), 44572000 (20%)
    - French accounting labels for all accounts
    - Mapping dictionaries (COMPTE_*_BY_TVA_RATE, LIBELLE_*_BY_TVA_RATE) for lookup by VAT rate
    - SUPPORTED_TVA_RATES list with Decimal values

- **Files changed in argile-lib-python:**
  - argile/modules/finances/__init__.py (new)
  - argile/modules/finances/constants.py (new)

- **Commit:** a5034162d

- **Learnings for future iterations:**
  - Use `Decimal(10)` instead of `Decimal("10")` for whole numbers to pass ruff FURB157 check
  - Keep `Decimal("5.5")` with string for fractional values
  - Module constants files don't need tests - type checking and linting are sufficient for pure constant definitions
---

## 2026-01-08 17:00 - US-004 (argile-lib-python)
- **What was implemented:**
  - Created schemas.py in the finances module with all FEC Pydantic schemas:
    - FECGenerateRequest: request schema for generating FEC (start_date, end_date, branch_ids)
    - FECLine: single line in FEC file (journal_code, ecriture_date, compte_num, compte_lib, comp_aux_lib, debit, credit)
    - InvoiceTaxBreakdown: tax breakdown by VAT rate (ht_by_rate, tva_by_rate, ttc_by_rate)
    - FECDocumentRead: read schema for FEC documents with download_url
    - FECWorkflowStarted: response when starting FEC workflow (document_id, workflow_id, status)
  - Updated __init__.py to export schemas module

- **Files changed in argile-lib-python:**
  - argile/modules/finances/schemas.py (new)
  - argile/modules/finances/__init__.py

- **Commit:** 02203d75a

- **Learnings for future iterations:**
  - Use `t.Annotated[type, Field(...)]` pattern consistently for schema fields
  - Import `from pydantic import Field` for schemas (not from sqlmodel)
  - Use `SQLModelConfig(from_attributes=True)` for models that will be converted from ORM objects
  - Use `dict[Decimal, Decimal]` for tax amount mappings indexed by rate
  - DocumentStatus literal can be imported from doc_instances models
---

## 2026-01-08 18:30 - US-005 (argile-lib-python)
- **What was implemented:**
  - Created permissions.py in the finances module with FEC permission management:
    - FECPermissionManager: registered for FEC_READ and FEC_CREATE events
    - Only ADMIN, OWNER, and MANAGER roles can access FEC features
    - Leads (LeadToken) are explicitly denied
  - Implemented get_accessible_branch_ids(user, session):
    - ADMIN: all branches in the system
    - OWNER: all branches in their companies (via company_ids)
    - MANAGER: only their assigned branches (via branch_ids)
    - Others: empty list (no FEC access)
  - Added helper functions:
    - load_fec_context: loads user from token
    - check_fec_permission: validates FEC_READ/FEC_CREATE permissions
    - validate_branch_access: ensures requested branches are accessible
  - Added FEC_CREATE and FEC_READ to EventType literal in argile/utils/events.py
  - Updated __init__.py to export permissions module

- **Files changed in argile-lib-python:**
  - argile/modules/finances/permissions.py (new)
  - argile/modules/finances/__init__.py
  - argile/utils/events.py

- **Commit:** 718b83bb9

- **Learnings for future iterations:**
  - Permission events must be added to EventType literal in argile/utils/events.py
  - Use decorator pattern `@auth.register_user_permission_manager("EVENT")` to register permissions
  - Import get_user_from_token from argile.crm.users.helpers at top level (no circular import issues)
  - For querying Branch.id (which can be None), filter results with list comprehension to satisfy mypy
  - crm.User has cached_property branch_ids and company_ids for efficient role-based scoping
---

## 2026-01-08 19:15 - US-006 (argile-lib-python)
- **What was implemented:**
  - Created helpers.py in the finances module with get_invoices_for_fec function
  - Function retrieves validated invoices filtered by:
    - Invoice submission date (submit_at) within provided date range
    - Invoice status in (accepted, paid, partially_paid) - defined as FEC_VALID_STATUSES constant
    - Lead's branch_id in the provided list of branch IDs
  - Uses SQLModel join pattern: Invoice -> Lead via lead_id
  - Returns empty list if no branch_ids provided (early return for efficiency)
  - Results ordered by submit_at date

- **Files changed in argile-lib-python:**
  - argile/modules/finances/helpers.py (new)
  - argile/modules/finances/__init__.py (added helpers export)

- **Commit:** cda762779

- **Learnings for future iterations:**
  - Use `col(Invoice.submit_at).is_not(None)` for null checks in SQLModel queries
  - Join pattern: `select(Model).join(RelatedModel, col(RelatedModel.id) == col(Model.fk_id))`
  - FEC valid statuses are: "accepted", "paid", "partially_paid"
  - Invoice relates to Lead via lead_id, Lead relates to Branch via branch_id
  - Ruff will auto-sort imports with `--fix` option if I001 error appears
---

## 2026-01-08 20:00 - US-007 (argile-lib-python)
- **What was implemented:**
  - Added extract_tax_breakdown(invoice) function to helpers.py
  - Function extracts HT/TVA/TTC amounts for each VAT rate (5.5%, 10%, 20%):
    - Uses funding.base_tax_rate_5_5, base_tax_rate_10, base_tax_rate_20 for HT amounts
    - Uses funding.total_tax_rate_5_5, total_tax_rate_10, total_tax_rate_20 for TVA amounts
    - Computes TTC as HT + TVA for each rate
  - Gets customer_number from invoice.lead.customer_number
  - Gets invoice_date from submit_at (or created_at if not available)
  - Returns InvoiceTaxBreakdown schema with amounts indexed by Decimal VAT rate

- **Files changed in argile-lib-python:**
  - argile/modules/finances/helpers.py (added extract_tax_breakdown function)

- **Commit:** 94fd928ac

- **Learnings for future iterations:**
  - Funding model uses float rates internally (0.055, 0.1, 0.2) but FEC constants use Decimal (5.5, 10, 20)
  - Convert float to Decimal via `Decimal(str(float_value))` for precision
  - Use assertion for mypy when accessing `invoice.id` which is technically `UUID | None`
  - Line length limit is 88 chars - split long ternary expressions into if/else blocks
---

## 2026-01-08 21:00 - US-008 (argile-lib-python)
- **What was implemented:**
  - Added generate_fec_lines(breakdown) function to helpers.py
  - Generates up to 9 FEC accounting lines per invoice:
    - 3 client TTC lines (Credit): customer receivable at full price with VAT
    - 3 work HT lines (Debit): revenue at price excluding VAT
    - 3 VAT collected lines (Debit): VAT liability to be remitted
  - CompAuxLib (auxiliary account label) set to customer_number for ALL lines
  - Added helper functions:
    - _format_amount(): formats Decimal with comma separator (1234,56)
    - _format_date_fec(): formats date as AAAAMMJJ
  - Lines with zero amounts are not generated
  - Uses constants from finances/constants.py for account numbers and labels

- **Files changed in argile-lib-python:**
  - argile/modules/finances/helpers.py (added generate_fec_lines and helpers)

- **Commit:** e6d8b4cd5

- **Learnings for future iterations:**
  - FEC line generation follows specific debit/credit rules:
    - Client TTC: Credit (customer owes money)
    - Work HT: Debit (revenue recognition)
    - VAT: Debit (tax liability)
  - French decimal format uses comma, not dot
  - Date format for FEC is AAAAMMJJ (strftime %Y%m%d)
  - Private helper functions prefixed with underscore per CLAUDE.md style
---

## 2026-01-08 22:00 - US-009 (argile-lib-python)
- **What was implemented:**
  - Added generate_fec_csv(lines) function to helpers.py
  - Generates FEC-compliant CSV files with:
    - Semicolon delimiter (FEC standard requirement)
    - UTF-8 encoding with BOM (b"\xef\xbb\xbf") for Excel compatibility
    - Headers: JournalCode, EcritureDate, CompteNum, CompteLib, CompAuxLib, Debit, Credit
  - Returns BytesIO object ready for S3 upload
  - Handles empty input (returns file with headers only)
  - Added constants: FEC_CSV_HEADERS (tuple), UTF8_BOM (bytes)

- **Files changed in argile-lib-python:**
  - argile/modules/finances/helpers.py (added generate_fec_csv function and constants)

- **Commit:** ec69a98ae

- **Learnings for future iterations:**
  - Use csv.writer with delimiter=";" for semicolon-separated files
  - UTF-8 BOM is 3 bytes: b"\xef\xbb\xbf" - prepend to bytes for Excel compatibility
  - Use io.StringIO for CSV writing, then encode to bytes, then wrap in io.BytesIO
  - BytesIO.seek(0) before returning to ensure it's ready to read
  - csv.QUOTE_MINIMAL is the default and appropriate for FEC format
---

## 2026-01-08 23:00 - US-010 (argile-lib-python)
- **What was implemented:**
  - Added create_pending_fec_document(start_date, end_date, branch_ids, user, session) function
  - Creates DocumentInstance with type=FEC_EXPORT, document_format=CSV
  - Sets status to "pending" for workflow processing
  - Stores parameters in document.data as JSON:
    - start_date: ISO format string
    - end_date: ISO format string
    - branch_ids: list of UUID strings
  - Generates title in format "FEC - DD/MM/AAAA - DD/MM/AAAA"
  - Added helper function _format_date_title for French date formatting
  - Associates document with user via user_id
  - Uses session.flush() to persist and get document ID

- **Files changed in argile-lib-python:**
  - argile/modules/finances/helpers.py (added create_pending_fec_document and _format_date_title functions)

- **Commit:** a8aa720c9

- **Learnings for future iterations:**
  - DocumentInstance.data field accepts dict[str, Any] via JSONB column
  - Use session.flush() to persist document and get its ID before returning
  - UUIDs must be serialized as strings for JSON storage
  - Date.isoformat() gives "YYYY-MM-DD" format suitable for JSON
  - DocumentInstance requires all imports from doc_instances.models.document
---

## 2026-01-08 23:45 - US-011 (argile-lib-python)
- **What was implemented:**
  - Created new argile/vendors/temporal/activities/documents.py module
  - Moved PDF generation functions from document_signatures.py:
    - _get_invoice_pdf_url: Generate PDF from invoice
    - _get_quote_pdf_url: Generate PDF from quote with attachments
    - _get_document_pdf_from_trame: Generate PDF from template URL
    - _get_pdf_from_html_url: Generate PDF via CloudConvert
  - Renamed activity generate_document_pdf → generate_document_file
  - Added backward compatibility alias: generate_document_pdf = generate_document_file
  - Added _get_fec_csv_url function for FEC_EXPORT document type:
    - Retrieves parameters (dates, branches) from document.data
    - Calls finance_helpers to get invoices, extract breakdowns, generate lines
    - Generates CSV via generate_fec_csv and uploads to S3
    - Sets document status to "signed" (no signature needed for CSV)
  - Added mark_document_as_error activity:
    - Sets document status to "rejected"
    - Stores error message in document.data["error"]
  - Updated __init__.py to export new functions

- **Files changed in argile-lib-python:**
  - argile/vendors/temporal/activities/documents.py (new)
  - argile/vendors/temporal/activities/__init__.py

- **Commit:** bfc464abe

- **Learnings for future iterations:**
  - Functions moved to new module but not removed from original yet (that's US-012)
  - The backward compat alias allows gradual migration
  - FEC documents use status="signed" since they don't require signatures
  - Document.data stores generation parameters as JSON (dates in ISO format, UUIDs as strings)
  - activity.logger is available inside temporal activities for structured logging
---

## 2026-01-08 - US-012 (argile-lib-python)
- **What was implemented:**
  - Removed duplicated PDF generation functions from document_signatures.py:
    - _get_invoice_pdf_url, _get_quote_pdf_url
    - _get_document_pdf_from_trame, _get_pdf_from_html_url
    - generate_document_pdf activity
  - Cleaned up unused imports (typing, doc_helpers, invoice_helpers, cloudconvert)
  - Added __all__ to explicitly declare module exports
  - The workflow create_document_signature.py continues to work via __init__.py exports

- **Files changed in argile-lib-python:**
  - argile/vendors/temporal/activities/document_signatures.py (removed ~135 lines)

- **Commit:** 5f854f9c8

- **Learnings for future iterations:**
  - When refactoring, the __init__.py serves as the public API - imports there work correctly
  - No need to re-import and re-export from the original module when __init__.py handles exports
  - __all__ makes module exports explicit and helps with IDE autocompletion
---

## 2026-01-08 - US-013 (argile-lib-python)
- **What was implemented:**
  - Created GenerateFECWorkflow for asynchronous FEC document generation
  - Workflow calls generate_document_file activity with 10-minute timeout
  - On failure, calls mark_document_as_error to set document status to rejected
  - Retry policy configured: 3 max attempts, 1s initial interval, 1min max interval
  - Non-retryable error types: NotFoundError, BadRequestError
  - Exported from workflows __init__.py

- **Files changed in argile-lib-python:**
  - argile/vendors/temporal/workflows/generate_fec.py (new)
  - argile/vendors/temporal/workflows/__init__.py

- **Commit:** e83a35947

- **Learnings for future iterations:**
  - Temporal workflows follow consistent pattern: @workflow.defn decorator, @workflow.run method
  - Use workflow.logger instead of standard logger inside workflow methods
  - workflow.execute_activity takes activity function reference, not string name
  - RetryPolicy non_retryable_error_types is a list of error class names as strings
---

## 2026-01-08 - US-014 (argile-lib-python)
- **What was implemented:**
  - Updated scripts/temporal/local_worker.py to register new FEC workflow and activities
  - Added GenerateFECWorkflow to the workflows list
  - Replaced generate_document_pdf with generate_document_file in activities list
  - Added mark_document_as_error to activities list
  - All pre-commit hooks pass (ruff, ty check, mypy, Vulture)

- **Files changed in argile-lib-python:**
  - scripts/temporal/local_worker.py

- **Commit:** b64c8a029

- **Learnings for future iterations:**
  - Worker registration is in scripts/temporal/local_worker.py
  - Activities and workflows are imported from argile.vendors.temporal.activities and workflows modules
  - The backward compat alias generate_document_pdf = generate_document_file is in activities __init__.py but worker should use the new name
---

## 2026-01-09 - US-015 (argile-lib-python)
- **What was implemented:**
  - Created api.py in finances module with router prefix=/finances
  - Implemented POST /finances/documents/generate endpoint
  - Added FEC permission validation (FEC_ALLOWED_ROLES: ADMIN, OWNER, MANAGER)
  - Added branch access validation based on user role:
    - ADMIN: all branches
    - OWNER: branches in their companies
    - MANAGER: their assigned branches
  - Creates pending FEC document and launches GenerateFECWorkflow
  - Returns FECWorkflowStarted response with document_id, workflow_id, status
  - Updated __init__.py to export api module

- **Files changed in argile-lib-python:**
  - argile/modules/finances/api.py (new)
  - argile/modules/finances/__init__.py

- **Commit:** b9aa117fb

- **Learnings for future iterations:**
  - Use router_manager.create_router() to create routers (like other modules)
  - Role-based branch access pattern: ADMIN → all, OWNER → company_ids, MANAGER → branch_ids
  - Temporal workflows are started via client.start_workflow() with make_task_queue("webhooks")
  - Commit session AFTER workflow is started successfully
  - Local imports for Temporal workflows to avoid circular dependencies (use noqa: PLC0415)
---

## 2026-01-09 - US-016 (argile-lib-python)
- **What was implemented:**
  - Added GET /finances/documents endpoint to list FEC documents
  - Filters FEC documents by type=FEC_EXPORT and not deleted
  - Checks user FEC_READ permission (ADMIN/OWNER/MANAGER only)
  - Filters results by accessible branches based on user role
  - A document is accessible if ANY of its branch_ids overlaps with user's accessible branches
  - Added _document_to_fec_read helper function to convert DocumentInstance to FECDocumentRead
  - Extracts start_date, end_date, branch_ids from document.data JSON field
  - Includes download_url only when document status is "signed"

- **Files changed in argile-lib-python:**
  - argile/modules/finances/api.py (added GET endpoint and helper function)

- **Commit:** c4537142e

- **Learnings for future iterations:**
  - FEC document parameters are stored in document.data as JSON (dates as ISO strings, UUIDs as strings)
  - Use date.fromisoformat() to parse ISO date strings back to date objects
  - Branch filtering is done in-memory after query since branch_ids are in JSON field
  - Import `date` at top-level to avoid ruff PLC0415 error about imports not at top-level
---

## 2026-01-09 - US-017 (argile-lib-python)
- **What was implemented:**
  - Added GET /finances/documents/{document_id} endpoint to retrieve specific FEC document details
  - Validates FEC_READ permission (ADMIN/OWNER/MANAGER only)
  - Validates branch access: user must have access to at least one branch in the document
  - Returns FECDocumentRead with download_url if document status is "signed"
  - Returns 404 if document not found or deleted
  - Returns 403 if user doesn't have access to any branch in the document

- **Files changed in argile-lib-python:**
  - argile/modules/finances/api.py (added GET /documents/{document_id} endpoint)

- **Commit:** 164c05c83

- **Learnings for future iterations:**
  - Reuse existing _get_accessible_branch_ids and _document_to_fec_read helpers for consistency
  - Branch access check uses set intersection: `doc_branch_ids & accessible_set` returns non-empty if any overlap
  - Negate with `not (...)` rather than checking `== set()` for empty set comparison
---

## 2026-01-09 - US-018 (argile-lib-python)
- **What was implemented:**
  - Added FECRenameRequest schema with new_title field (min_length=1, max_length=255)
  - Added DELETE /finances/documents/{document_id} endpoint for soft delete:
    - Sets deleted_at timestamp using datetime.now(UTC)
    - Validates FEC_CREATE permission (write operation)
    - Validates branch access (user must have access to at least one branch)
    - Returns the deleted document
  - Added PUT /finances/documents/{document_id}/rename endpoint:
    - Updates document.title to new_title from request
    - Same permission and branch access validation as DELETE

- **Files changed in argile-lib-python:**
  - argile/modules/finances/schemas.py (added FECRenameRequest schema)
  - argile/modules/finances/api.py (added DELETE and PUT rename endpoints)

- **Commit:** 7f539167e

- **Learnings for future iterations:**
  - Use `datetime.now(UTC)` with UTC imported from datetime module (not timezone.utc) for ruff UP017 compliance
  - Import datetime at top-level to avoid ruff PLC0415 error
  - Soft delete pattern: set deleted_at timestamp, don't actually remove from database
  - All write operations (DELETE, PUT) use FEC_CREATE permission, not FEC_READ
---

## 2026-01-09 - US-019 (argile-lib-python)
- **What was implemented:**
  - Added GET /finances/branches endpoint to list accessible branches for FEC export
  - Validates FEC_READ permission (ADMIN/OWNER/MANAGER only)
  - Returns branches based on user role:
    - ADMIN: all branches in the system
    - OWNER: all branches in their companies
    - MANAGER: only their assigned branches
  - Uses existing crm.BranchRead schema for response
  - Reuses _get_accessible_branch_ids helper function already in api.py

- **Files changed in argile-lib-python:**
  - argile/modules/finances/api.py (added GET /branches endpoint)

- **Commit:** 2c4087c49

- **Learnings for future iterations:**
  - crm.BranchRead schema is already exported from crm module - no need to create a new schema
  - Use model_validate() to convert SQLModel objects to Pydantic schemas
  - Order branches by name for consistent UI display
---

## 2026-01-09 - US-020 (argile-lib-python)
- **What was implemented:**
  - Registered the finances module in argile/modules/__init__.py
  - Added finances to the import list (alphabetically between evaluation and insurance_providers)
  - Added finances to the __all__ export list
  - Router registration happens automatically via the router_manager pattern when the module is imported

- **Files changed in argile-lib-python:**
  - argile/modules/__init__.py (added finances import and export)

- **Commit:** cf5e55604

- **Learnings for future iterations:**
  - Router registration in this codebase follows a singleton pattern via router_manager
  - When a module is imported (via modules/__init__.py), its api.py is imported which calls router_manager.create_router()
  - Then argile/__init__.py calls router_manager.include_routers() to register all routers with the FastAPI app
  - No need to manually call app.include_router() - just import the module in modules/__init__.py
  - Keep imports alphabetically sorted in modules/__init__.py
---

## 2026-01-09 - US-021 (argile-lib-python)
- **What was implemented:**
  - Added 3 required unit tests for FEC helpers:
    - test_extract_tax_breakdown_with_multiple_rates: Tests extraction of tax breakdown with all three VAT rates (5.5%, 10%, 20%)
    - test_generate_fec_lines_classic_invoice: Tests FEC line generation for a classic invoice with proper debit/credit entries
    - test_format_amount_french_locale: Tests French locale formatting with comma as decimal separator
  - Test structure argile/modules/finances/test/ already existed from previous iterations
  - All tests validate the core FEC accounting logic

- **Files changed in argile-lib-python:**
  - argile/modules/finances/test/test_data_helpers.py (added test_extract_tax_breakdown_with_multiple_rates)
  - argile/modules/finances/test/test_csv_helpers.py (added test_generate_fec_lines_classic_invoice, test_format_amount_french_locale)

- **Commit:** e9325e55f

- **Learnings for future iterations:**
  - Test structure was already created with comprehensive tests; only specific named tests from acceptance criteria were missing
  - Tests can be run with `uv run pytest` but require environment variables - use `uv run ruff check` and `uv run mypy` for code validation without full env
  - Pre-commit hooks automatically run on commit: ruff check, ty check, mypy, Vulture
  - All tests follow the pattern: setup mock objects → call function → assert expected results
---

## 2026-01-09 - US-022 (argile-lib-python)
- **What was implemented:**
  - Created integration tests for FEC API endpoints and permissions
  - 8 test functions covering all acceptance criteria:
    - test_generate_fec_owner_success: OWNER can generate FEC for company branches
    - test_generate_fec_manager_own_branches: MANAGER can only access their assigned branches
    - test_generate_fec_regular_forbidden: REGULAR users are forbidden from all FEC endpoints
    - test_owner_sees_all_company_branches: OWNER sees branches from their company only
    - test_list_fec_documents_requires_permission: Tests auth for document listing
    - test_get_fec_document_requires_permission: Tests auth for document retrieval
    - test_admin_can_access_all_branches: ADMIN sees all branches in system
    - test_generate_fec_validates_date_range: Date validation works correctly
  - Used AsyncMock to mock Temporal client and workflow execution
  - Used FixtureData from argile/conftest.py for test data (owner_user, manager_user, etc.)

- **Files changed in argile-lib-python:**
  - argile/modules/finances/test/test_api.py (new - 327 lines)

- **Commit:** 9cb47e959

- **Learnings for future iterations:**
  - Use `data` fixture from argile/conftest.py for owner_token and owner_user (not available in my_housing_data)
  - Mock Temporal client with AsyncMock for workflow tests
  - Pre-commit hooks validate: ruff, ty check, mypy, Vulture
  - Integration tests should test permission boundaries (403 for forbidden access)
  - Remove unused function arguments to pass ruff ARG001 check
  - Import uuid at top-level to avoid ruff PLC0415 error
---

## 2026-01-09 - US-023 to US-033 (remi-web-ui)
- **What was implemented:**
  - Created complete FEC export frontend feature in app/settings/finances/
  - US-023: TypeScript types and Zod schemas (schemas.ts)
    - FecExportStatus enum (PENDING, SIGNED, REJECTED)
    - FecExport, FecGenerateRequest, FecWorkflowStarted, FecRenameRequest types
    - ApiFecExport, ApiFecWorkflowStarted API types for snake_case backend communication
  - US-024: API functions (api.ts)
    - getFecExports, getFecExport, generateFec, deleteFecExport, renameFecExport, getAccessibleBranches
    - Manual date conversion from API strings to Date objects
  - US-025: useFecExports hook - React Query hook for listing exports
  - US-026: useFecExport hook - Polling every 2 seconds while status=pending
  - US-027: useGenerateFec mutation hook - Invalidates cache on success
  - US-028: Finances page (page.tsx) with title, table, and generate button
  - US-029: FecStatusBadge - Yellow/green/red badges for status
  - US-030: FecExportsTable - Table with all columns and empty state
  - US-031: FecActions - Menu with download/rename/delete actions and dialogs
  - US-032: GenerateFecModal - Date range, branch selection, generate flow
  - US-033: Polling and feedback - Spinner, progress messages, completion states

- **Files changed in remi-web-ui:**
  - app/settings/finances/core/schemas.ts (new)
  - app/settings/finances/core/api.ts (new)
  - app/settings/finances/core/hooks/useFecExports.ts (new)
  - app/settings/finances/core/hooks/useFecExport.ts (new)
  - app/settings/finances/core/hooks/useGenerateFec.ts (new)
  - app/settings/finances/core/hooks/useDeleteFecExport.ts (new)
  - app/settings/finances/core/hooks/useRenameFecExport.ts (new)
  - app/settings/finances/core/hooks/useAccessibleBranches.ts (new)
  - app/settings/finances/components/FecStatusBadge.tsx (new)
  - app/settings/finances/components/FecExportsTable.tsx (new)
  - app/settings/finances/components/FecActions.tsx (new)
  - app/settings/finances/components/GenerateFecModal.tsx (new)
  - app/settings/finances/page.tsx (new)

- **Commit:** 4f4082935

- **Learnings for future iterations:**
  - API responses use snake_case, frontend uses camelCase - need manual conversion
  - Date fields from API are strings, must convert to Date objects explicitly
  - React Query refetchInterval can be a function that returns false to stop polling
  - Keep internal constants/functions private (no export) to pass knip checks
  - Chakra UI Portal is needed for Menu overlays inside tables
  - Follow existing patterns: useApi hook, convertToCamelCase (but be careful with dates)
---

## 2026-01-09 - US-034 (remi-web-ui)
- **What was implemented:**
  - Added Finances navigation link to settings menu
  - Link visible only for ADMIN/OWNER/MANAGER roles
  - Uses CHART icon with light blue background color

- **Files changed in remi-web-ui:**
  - services/routes.ts (added finances route)
  - crm/leads/components/MainSidebar/MainSettingsMenu.tsx (added Finances menu item with role filtering)

- **Commit:** ab901e492

- **Learnings for future iterations:**
  - Settings menu items are defined in SETTINGS_ITEMS array in MainSettingsMenu.tsx
  - Use requiresHighRole flag on menu items to filter by role
  - useTeamMemberToken and useTeamMember hooks provide access to current user's role
  - isManagerOwnerOrAdmin helper checks for ADMIN, OWNER, MANAGER roles
---

## 2026-01-09 - US-035 (remi-web-ui)
- **What was implemented:**
  - Added access control to finances page
  - Shows unauthorized message for REGULAR users
  - Shows loading spinner while checking role

- **Files changed in remi-web-ui:**
  - app/settings/finances/page.tsx (added role check and unauthorized view)

- **Commit:** e9ab95e25

- **Learnings for future iterations:**
  - Pattern for access control: show loading while fetching role, then check with isManagerOwnerOrAdmin
  - Use same pattern as storyboard page for unauthorized message
  - Build must pass for final acceptance (npm run build)
---
